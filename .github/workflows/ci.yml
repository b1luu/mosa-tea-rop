name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  lint-and-syntax:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff lint check
        run: ruff check src

      - name: Python syntax compile check
        run: python -m compileall -q src

  clean-and-validate:
    runs-on: ubuntu-latest
    needs: lint-and-syntax

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: Build synthetic fixture (privacy-safe)
        run: |
          python - <<'PY'
          import csv
          from pathlib import Path

          fixture_path = Path("tmp/ci_raw_fixture.csv")
          fixture_path.parent.mkdir(parents=True, exist_ok=True)

          rows = [
              {
                  "Date": "2026-01-01",
                  "Category": "Mosa Signature",
                  "Item": "TGY Special",
                  "Qty": "1",
                  "Modifiers Applied": "50% Ice, 75% Sugar",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-01",
                  "Category": "Mosa Signature",
                  "Item": "TGY Special",
                  "Qty": "-1",
                  "Modifiers Applied": "50% Ice, 75% Sugar",
                  "Event Type": "Refund",
              },
              {
                  "Date": "2026-01-02",
                  "Category": "",
                  "Item": "Tip",
                  "Qty": "1",
                  "Modifiers Applied": "",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-02",
                  "Category": "",
                  "Item": "Custom Amount",
                  "Qty": "1",
                  "Modifiers Applied": "",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-02",
                  "Category": "Rewards",
                  "Item": "Free Drink (100\u263c Reward)",
                  "Qty": "1",
                  "Modifiers Applied": "",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-03",
                  "Category": "Merchandise",
                  "Item": "Boba Tea Tote Bag",
                  "Qty": "1",
                  "Modifiers Applied": "",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-04",
                  "Category": "Seasonal Special",
                  "Item": "Hot Spice Apple Tea Cider",
                  "Qty": "1",
                  "Modifiers Applied": "50% Sugar",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-05",
                  "Category": "Matcha Series",
                  "Item": "Strawberry Matcha Latte",
                  "Qty": "1",
                  "Modifiers Applied": "50% Sugar",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-05",
                  "Category": "Matcha Series",
                  "Item": "Mango Matcha Latte",
                  "Qty": "1",
                  "Modifiers Applied": "No Sugar",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-05",
                  "Category": "Seasonal Special",
                  "Item": "Chestnut Forest",
                  "Qty": "1",
                  "Modifiers Applied": "25% Sugar",
                  "Event Type": "Payment",
              },
              {
                  "Date": "2026-01-06",
                  "Category": "Mosa Signature 精選特調",
                  "Item": "Tie Guan Yin Milk Tea 鐵觀音奶茶",
                  "Qty": "1",
                  "Modifiers Applied": "100% Ice, 100% Sugar",
                  "Event Type": "Payment",
              },
          ]

          fieldnames = ["Date", "Category", "Item", "Qty", "Modifiers Applied", "Event Type"]
          with fixture_path.open("w", newline="", encoding="utf-8") as f:
              writer = csv.DictWriter(f, fieldnames=fieldnames)
              writer.writeheader()
              writer.writerows(rows)

          print(f"Wrote fixture: {fixture_path}")
          PY

      - name: Run cleaning pipeline
        run: python src/clean.py --input tmp/ci_raw_fixture.csv --output tmp/ci_clean.csv

      - name: Validate cleaned dataset
        run: |
          python - <<'PY'
          from pathlib import Path
          import pandas as pd

          output_path = Path("tmp/ci_clean.csv")
          if not output_path.exists():
              raise SystemExit("clean.csv was not created.")

          df = pd.read_csv(output_path, low_memory=False)

          required_cols = {
              "Date",
              "Category",
              "Item",
              "Qty",
              "Modifiers Applied",
              "ice_pct",
              "sugar_pct",
          }
          missing = required_cols - set(df.columns)
          if missing:
              raise SystemExit(f"Missing required columns: {sorted(missing)}")

          qty = pd.to_numeric(df["Qty"], errors="coerce")
          if qty.isna().any():
              raise SystemExit("Qty has non-numeric values.")
          if (qty <= 0).any():
              raise SystemExit("Qty contains zero or negative values after cleaning.")

          category_blank = df["Category"].isna() | df["Category"].astype(str).str.strip().eq("")
          if category_blank.any():
              raise SystemExit("Category has blank or null values.")

          if df["Category"].fillna("").eq("Merchandise").any():
              raise SystemExit("Merchandise rows were not removed.")

          if df["Item"].fillna("").eq("Free Drink (100☼ Reward)").any():
              raise SystemExit("Free reward rows were not removed.")

          fixed_ice_items = {"Strawberry Matcha Latte", "Mango Matcha Latte", "Chestnut Forest"}
          fixed = df["Item"].isin(fixed_ice_items)
          if fixed.any():
              fixed_ice = pd.to_numeric(df.loc[fixed, "ice_pct"], errors="coerce")
              if fixed_ice.isna().any():
                  raise SystemExit("Fixed-ice items still have blank ice_pct.")
              if (fixed_ice != 100).any():
                  raise SystemExit("Fixed-ice items have non-100 ice_pct.")

          # Fixture-specific assertions.
          if len(df) != 6:
              raise SystemExit(f"Unexpected cleaned row count for fixture: {len(df)} (expected 6).")

          hot_row = df.loc[df["Item"].eq("Hot Spice Apple Tea Cider")]
          if hot_row.empty:
              raise SystemExit("Hot Spice Apple Tea Cider row missing after cleaning.")
          hot_ice = pd.to_numeric(hot_row["ice_pct"], errors="coerce")
          if hot_ice.isna().any() or (hot_ice != 0).any():
              raise SystemExit("Hot Spice Apple Tea Cider should have ice_pct=0.")

          print("Validation passed.")
          print(f"Rows: {len(df)}")
          print(f"Qty sum: {qty.sum()}")
          PY
